{{> header}}
{{#game}}
<div class="alert hidden" id="alert" role="alert"></div>
<div class="row">
	<!-- The NorthWest, North, and North East Piles -->
	<div class="gamePile pile col-md-3" pile="NORTH_WEST_PILE">
		{{#northWestPile}}
			<div class="card {{#isFirst}}bottom{{/isFirst}} {{#isRed}}red{{/isRed}}" number="{{number}}" suit="{{suit.displayName}}">
			{{displayNumber}} {{{suit.html}}}
			</div>
		{{/northWestPile}}
		{{^northWestPile}}
			<div class="emptyPile"></div>
		{{/northWestPile}}
	</div>
	<div class="gamePile pile col-md-3" pile="NORTH_PILE">
		{{#northPile}}
			<div class="card {{#isFirst}}bottom{{/isFirst}} {{#isRed}}red{{/isRed}}" number="{{number}}" suit="{{suit.displayName}}">
			{{displayNumber}} {{{suit.html}}}
			</div>
		{{/northPile}}
		{{^northPile}}
			<div class="emptyPile"></div>
		{{/northPile}}
	</div>
	<div class="gamePile pile col-md-3" pile="NORTH_EAST_PILE">
		{{#northEastPile}}
			<div class="card {{#isFirst}}bottom{{/isFirst}} {{#isRed}}red{{/isRed}}" number="{{number}}" suit="{{suit.displayName}}">
			{{displayNumber}} {{{suit.html}}}
			</div>
		{{/northEastPile}}
		{{^northEastPile}}
			<div class="emptyPile"></div>
		{{/northEastPile}}
	</div>
</div>
<div class="row">
	<!-- The West, Draw, and East Piles -->
	<div class="gamePile pile col-md-3" pile="WEST_PILE">
		{{#westPile}}
			<div class="card {{#isFirst}}bottom{{/isFirst}} {{#isRed}}red{{/isRed}}" number="{{number}}" suit="{{suit.displayName}}">
			{{displayNumber}} {{{suit.html}}}
			</div>
		{{/westPile}}
		{{^westPile}}
			<div class="emptyPile"></div>
		{{/westPile}}
	</div>
	<div class="gamePile pile col-md-3">
		<div id="drawPile" class="card" pile="DRAW_PILE">Draw ({{drawPile.size}})</div>
	</div>
	<div class="gamePile pile col-md-3" pile="EAST_PILE">
		{{#eastPile}}
			<div class="card {{#isFirst}}bottom{{/isFirst}} {{#isRed}}red{{/isRed}}" number="{{number}}" suit="{{suit.displayName}}">
			{{displayNumber}} {{{suit.html}}}
			</div>
		{{/eastPile}}
		{{^eastPile}}
			<div class="emptyPile"></div>
		{{/eastPile}}
	</div>
</div>
<div class="row">
	<!-- The SouthWest, South, and SouthEast Pile -->
	<div class="gamePile pile col-md-3" pile="SOUTH_WEST_PILE">
		{{#southWestPile}}
			<div class="card {{#isFirst}}bottom{{/isFirst}} {{#isRed}}red{{/isRed}}" number="{{number}}" suit="{{suit.displayName}}">
			{{displayNumber}} {{{suit.html}}}
			</div>
		{{/southWestPile}}
		{{^southWestPile}}
			<div class="emptyPile"></div>
		{{/southWestPile}}
	</div>
	<div class="gamePile pile col-md-3" pile="SOUTH_PILE">
		{{#southPile}}
			<div class="card {{#isFirst}}bottom{{/isFirst}} {{#isRed}}red{{/isRed}}" number="{{number}}" suit="{{suit.displayName}}">
			{{displayNumber}} {{{suit.html}}}
			</div>
		{{/southPile}}
		{{^southPile}}
			<div class="emptyPile"></div>
		{{/southPile}}
	</div>
	<div class="gamePile pile col-md-3" pile="SOUTH_EAST_PILE">
		{{#southEastPile}}
			<div class="card {{#isFirst}}bottom{{/isFirst}} {{#isRed}}red{{/isRed}}" number="{{number}}" suit="{{suit.displayName}}">
			{{displayNumber}} {{{suit.html}}}
			</div>
		{{/southEastPile}}
		{{^southEastPile}}
			<div class="emptyPile"></div>
		{{/southEastPile}}		
	</div>
</div>
<div class="row">
	Your hand ({{#userHand.size}}{{userHand.size}}{{/userHand.size}} Remaining Cards):
	<div class="viewingHand">
		{{#userHand}}
			<div class="userCard card col-md-3 {{#isRed}}red{{/isRed}} {{^isTurn}}greyedOut{{/isTurn}}" number="{{number}}" suit="{{suit.displayName}}">
			{{displayNumber}} {{{suit.html}}}
			</div>
		{{/userHand}}
	</div>
</div>

<div class="row">
	<!-- The Other Player's Piles -->
	<h4>Other Players:</h4>
	<ul>
	{{#otherPlayers}}
		{{this}}
			<li>{{userName}} ({{cards.size}} Remaining Cards)</li>
		{{this}}
	{{/otherPlayers}}
	</ul>
</div>



<script type = text/javascript>

	var isTurn;
	
	{{#isTurn}}
	isTurn = true;
	{{/isTurn}}
	{{^isTurn}}
	isTurn = false;
	{{/isTurn}}

	window.onload = function (){
		setTimeout(function (){
			window.location.replace("/game/" + {{gameId}});
		}, 10000);
	}
	
	$("#drawPile").click(function (){
		handleTurn();
	});

	function handleTurn(){
		if(isTurn){
			turnForm=document.createElement('FORM');
			turnForm.name='turn';
			turnForm.method='POST';
			turnForm.action='/turn';
			
			hiddenElement=document.createElement('INPUT');
			hiddenElement.type='HIDDEN';
			hiddenElement.name='gameId';
			hiddenElement.value={{gameId}};
			turnForm.appendChild(hiddenElement);
			turnForm.submit();
		} else {
			notTurnAlert();
		}
	}
	var selectedCard;
	var selectedPile;
	var secondPile;
	$(".userCard").click(function (){
		if(isTurn){
			if($(this).hasClass("clicked")){
				// The currently selected card has been clicked
				$(this).removeClass("clicked");
				selectedCard = null;
			} else if(!selectedCard){
				// A new card has been clicked
				$(this).addClass("clicked");
				selectedCard = $(this);
				if(selectedPile){
					move();
				}
			} else {
				if($(this).attr("id") == "drawPile"){
					handleTurn()
				} else {
					// This is a different card from the one currently selected
					selectedCard.removeClass("clicked");
					$(this).addClass("clicked");
					selectedCard = $(this);
				}
			}
		} else {
			notTurnAlert();
		}
	});
	
	$(".gamePile").click(function (){
		if(isTurn){
			if($(this).children().first().hasClass("pileClicked")){
			 	// Unclick the currently selected pile
				$(this).children().first().removeClass("pileClicked");
				selectedPile = null;
			} else if(!selectedPile){
				// This is the first selected pile
				$(this).children().first().addClass("pileClicked");
				selectedPile = $(this);
				if(selectedCard){
					move();
				}			
			} else {
				// This is the second selected pile
				if($(this).children().first().attr("id") != "drawPile"){
					$(this).children().first().addClass("pileClicked");
					secondPile = $(this);
					move();
				}
			}
		} else {
			notTurnAlert();
		}
	});	
	
	function notTurnAlert(){
		$("#alert").html("It is not your turn.");
		$("#alert").addClass("alert-danger");
		$("#alert").removeClass("hidden");
		setTimeout(function(){ 
			$("#alert").html("");
			$("#alert").removeClass("alert-danger");
			$("#alert").addClass("hidden");
		}, 5000);
	}
	
	function move(){
		moveForm=document.createElement('FORM');
		moveForm.name='makeMove';
		moveForm.method='POST';
		moveForm.action='/move';
		
		hiddenElement=document.createElement('INPUT');
		hiddenElement.type='HIDDEN';
		hiddenElement.name='pile';
		hiddenElement.value=selectedPile.attr("pile");
		moveForm.appendChild(hiddenElement);
		if(selectedCard){
			hiddenElement=document.createElement('INPUT');
			hiddenElement.type='HIDDEN';
			hiddenElement.name='number';
			hiddenElement.value=selectedCard.attr("number");
			moveForm.appendChild(hiddenElement);
			hiddenElement=document.createElement('INPUT');
			hiddenElement.type='HIDDEN';
			hiddenElement.name='suit';
			hiddenElement.value=selectedCard.attr("suit");
			moveForm.appendChild(hiddenElement);
		} else if(secondPile){
			hiddenElement=document.createElement('INPUT');
			hiddenElement.type='HIDDEN';
			hiddenElement.name='pile2';
			hiddenElement.value=secondPile.attr("pile");
			moveForm.appendChild(hiddenElement);
		}
		hiddenElement=document.createElement('INPUT');
		hiddenElement.type='HIDDEN';
		hiddenElement.name='gameId';
		hiddenElement.value={{gameId}};
		moveForm.appendChild(hiddenElement);
		moveForm.submit();	
	}
</script>
{{/game}}
{{> footer}}